<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Recomendador de Artista</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {margin: 0; padding: 0; font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; background-color: #121212; color: #fff;}
#content {max-width: 600px; margin: 40px auto; padding: 0 20px;}
button {background-color: #1DB954; border: none; color: #fff; padding: 15px 20px; font-size: 16px; border-radius: 25px; cursor: pointer; width: 100%; margin-bottom: 20px;}
button:hover {opacity: 0.9;}
h1, h2, h3 {margin: 10px 0;}
#progress {text-align: center; margin-bottom: 20px; font-size: 14px;}
.secao {margin-bottom: 30px;}
.lista {display: flex; flex-direction: column; gap: 10px;}
.card {display: flex; align-items: center; text-decoration: none; background-color: #181818; padding: 10px; border-radius: 8px; border: 1px solid #282828; box-shadow: 0 2px 4px rgba(0,0,0,0.5); overflow: hidden; height: 80px;}
.card img {width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 10px;}
.nome-generos {flex: 1; display: flex; flex-direction: column; justify-content: center;}
.generos-artista {display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;}
.tag-genero {background-color: #282828; padding: 2px 6px; border-radius: 4px; font-size: 12px;}
.arrow {font-size: 24px; color: #1DB954; margin-left: 10px;}
@media (max-width: 600px) {
  .card {height: 70px; padding: 8px;}
  .card img {width: 50px; height: 50px; margin-right: 8px;}
  .arrow {font-size: 20px; margin-left: 8px;}
}
</style>
</head>
<body>
<div id="content"></div>
<script>
(function(){
const CLIENT_ID = 'cdbe0b644b984a6e98839e352d87bb3d';
const REDIRECT_URI = 'https://gandradeiasi.github.io/recomendador-de-artista-2/';
const SCOPES = 'user-top-read';
let accessToken = null;
const params = new URLSearchParams(window.location.hash.substring(1));
if(params.has('access_token')){
  accessToken = params.get('access_token');
  window.history.pushState("", document.title, window.location.pathname + window.location.search);
}
function setProgress(msg){
  let prog = document.getElementById('progress');
  if(prog) prog.innerText = msg;
}
function showLogin(){
  document.getElementById('content').innerHTML = '<button id="loginButton">Login com Spotify</button><div id="progress" style="margin-top:20px;"></div>';
  document.getElementById('loginButton').addEventListener('click',function(){
    let authUrl = 'https://accounts.spotify.com/authorize?client_id=' + CLIENT_ID + '&redirect_uri=' + encodeURIComponent(REDIRECT_URI) + '&scope=' + encodeURIComponent(SCOPES) + '&response_type=token';
    window.location = authUrl;
  });
}
if(!accessToken){ showLogin(); return; }
if(!document.getElementById('progress')){
  document.getElementById('content').innerHTML = '<div id="progress" style="margin-top:20px;"></div>';
}
async function fetchTopTracks(){
  let allTracks = [];
  let offset = 0;
  let limit = 50;
  let total = 1;
  while(offset < total && allTracks.length < 1000){
    setProgress('Carregando top tracks: ' + allTracks.length);
    let url = `https://api.spotify.com/v1/me/top/tracks?limit=${limit}&offset=${offset}`;
    let response = await fetch(url,{headers:{'Authorization':'Bearer ' + accessToken}});
    let data = await response.json();
    if(!data.items) break;
    total = data.total;
    allTracks = allTracks.concat(data.items);
    offset += limit;
  }
  return allTracks.slice(0,1000);
}
async function fetchArtistsDetails(artistIds){
  let artists = {};
  let ids = Array.from(artistIds);
  for(let i=0;i<ids.length;i+=50){
    let batch = ids.slice(i,i+50);
    setProgress('Carregando detalhes de artistas: ' + (i+batch.length) + '/' + ids.length);
    let url = 'https://api.spotify.com/v1/artists?ids=' + batch.join(',');
    let response = await fetch(url,{headers:{'Authorization':'Bearer ' + accessToken}});
    let data = await response.json();
    if(data.artists){
      data.artists.forEach(artist=>{ artists[artist.id] = artist; });
    }
  }
  return artists;
}
function buildGenreDict(tracks,artistDetails){
  let genreDict = {};
  tracks.forEach(track=>{
    let trackGenres = new Set();
    track.artists.forEach(artist=>{
      let details = artistDetails[artist.id];
      if(details && details.genres){
        details.genres.forEach(g=> trackGenres.add(g));
      }
    });
    trackGenres.forEach(g=>{
      if(genreDict[g]){ genreDict[g]++; } else { genreDict[g] = 1; }
    });
  });
  return genreDict;
}
function splitScores(scores){
  let L = scores.length;
  let base = Math.floor(L/3);
  let rem = L % 3;
  let menos = scores.slice(0, base);
  let medio = scores.slice(base, base+base+rem);
  let mais = scores.slice(base+base+rem);
  return {menos,medio,mais};
}
function getRandomElements(array,count){
  let copy = array.slice();
  let result = [];
  for(let i=0;i<count && copy.length>0;i++){
    let index = Math.floor(Math.random()*copy.length);
    result.push(copy[index]);
    copy.splice(index,1);
  }
  return result;
}
async function searchArtistByGenre(genre,topArtistIds){
  let foundArtists = [];
  let offset = 0;
  while(foundArtists.length < 3){
    let useQuotes = Math.random()<0.5;
    let query = useQuotes ? `genre:"${genre}"` : `genre:${genre}`;
    let url = `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=artist&limit=20&offset=${offset}`;
    setProgress('Buscando artistas para o gênero ' + genre + ': offset ' + offset);
    let response = await fetch(url,{headers:{'Authorization':'Bearer ' + accessToken}});
    let data = await response.json();
    if(!data.artists || !data.artists.items || data.artists.items.length===0) break;
    let filtered = data.artists.items.filter(a=> !topArtistIds.has(a.id));
    foundArtists = foundArtists.concat(filtered);
    if(data.artists.items.length < 20) break;
    offset += 20;
  }
  if(foundArtists.length > 3){
    foundArtists = getRandomElements(foundArtists,foundArtists.length);
  }
  return foundArtists;
}
async function generateRecommendations(genreDict,topArtistIds){
  let scores = Array.from(new Set(Object.values(genreDict))).sort((a,b)=> a-b);
  let parts = splitScores(scores);
  let recScoresMenos = getRandomElements(parts.menos,3);
  let recScoresMedio = getRandomElements(parts.medio,3);
  let recScoresMais = getRandomElements(parts.mais,3);
  let recGenres = {menos:[],medio:[],mais:[]};
  recScoresMenos.forEach(score=>{
    let gs = Object.keys(genreDict).filter(g=> genreDict[g]===score);
    recGenres.menos.push(gs[Math.floor(Math.random()*gs.length)]);
  });
  recScoresMedio.forEach(score=>{
    let gs = Object.keys(genreDict).filter(g=> genreDict[g]===score);
    recGenres.medio.push(gs[Math.floor(Math.random()*gs.length)]);
  });
  recScoresMais.forEach(score=>{
    let gs = Object.keys(genreDict).filter(g=> genreDict[g]===score);
    recGenres.mais.push(gs[Math.floor(Math.random()*gs.length)]);
  });
  let recommendations = {menos:[],medio:[],mais:[]};
  for(let group in recGenres){
    for(let genre of recGenres[group]){
      let artists = await searchArtistByGenre(genre,topArtistIds);
      if(artists.length >= 3){
        let chosen = artists[Math.floor(Math.random()*artists.length)];
        recommendations[group].push(chosen);
      } else if(artists.length>0){
        let chosen = artists[Math.floor(Math.random()*artists.length)];
        recommendations[group].push(chosen);
      }
    }
  }
  let recSet = new Set();
  for(let group in recommendations){
    recommendations[group] = recommendations[group].filter(artist=>{
      if(recSet.has(artist.id)) return false;
      recSet.add(artist.id);
      return true;
    });
  }
  return recommendations;
}
function renderRecommendations(recommendations){
  let html = '<h1 style="text-align:center;margin-top:20px;">Artistas recomendados:</h1>';
  html += '<div class="secao"><h2>Gêneros que você mais ouve</h2><div class="lista">';
  (recommendations.mais||[]).forEach(artist=>{
    html += `<a href="${artist.external_urls.spotify}" target="_blank" class="card"><img src="${artist.images && artist.images.length ? artist.images[artist.images.length-1].url : ''}" alt="${artist.name}"><div class="nome-generos"><h3>${artist.name}</h3><div class="generos-artista">`;
    if(artist.genres){
      artist.genres.forEach(g=>{
        html += `<div class="tag-genero">${g}</div>`;
      });
    }
    html += `</div></div><div class="arrow">→</div></a>`;
  });
  html += '</div></div>';
  html += '<div class="secao"><h2>Gêneros que você ouve mais ou menos</h2><div class="lista">';
  (recommendations.medio||[]).forEach(artist=>{
    html += `<a href="${artist.external_urls.spotify}" target="_blank" class="card"><img src="${artist.images && artist.images.length ? artist.images[artist.images.length-1].url : ''}" alt="${artist.name}"><div class="nome-generos"><h3>${artist.name}</h3><div class="generos-artista">`;
    if(artist.genres){
      artist.genres.forEach(g=>{
        html += `<div class="tag-genero">${g}</div>`;
      });
    }
    html += `</div></div><div class="arrow">→</div></a>`;
  });
  html += '</div></div>';
  html += '<div class="secao"><h2>Gêneros que você menos ouve</h2><div class="lista">';
  (recommendations.menos||[]).forEach(artist=>{
    html += `<a href="${artist.external_urls.spotify}" target="_blank" class="card"><img src="${artist.images && artist.images.length ? artist.images[artist.images.length-1].url : ''}" alt="${artist.name}"><div class="nome-generos"><h3>${artist.name}</h3><div class="generos-artista">`;
    if(artist.genres){
      artist.genres.forEach(g=>{
        html += `<div class="tag-genero">${g}</div>`;
      });
    }
    html += `</div></div><div class="arrow">→</div></a>`;
  });
  html += '</div></div>';
  html += '<div style="text-align:center;margin:20px;"><button id="newRec">Gerar novas recomendações</button></div>';
  document.getElementById('content').innerHTML = html;
  document.getElementById('newRec').addEventListener('click', async function(){
    document.getElementById('content').innerHTML = '<div id="progress" style="margin-top:20px;">Gerando novas recomendações...</div>';
    let stored = localStorage.getItem('genreDictData');
    let data = JSON.parse(stored);
    let recommendations = await generateRecommendations(data.dict, new Set(data.topArtistIds));
    renderRecommendations(recommendations);
  });
}
async function main(){
  let stored = localStorage.getItem('genreDictData');
  let today = new Date().toISOString().split('T')[0];
  let genreDict, topArtistIds;
  if(stored){
    let parsed = JSON.parse(stored);
    if(parsed.date===today){
      genreDict = parsed.dict;
      topArtistIds = new Set(parsed.topArtistIds);
    }
  }
  if(!genreDict){
    let tracks = await fetchTopTracks();
    let artistIdSet = new Set();
    tracks.forEach(track=>{
      track.artists.forEach(artist=>{
        artistIdSet.add(artist.id);
      });
    });
    topArtistIds = artistIdSet;
    let artistDetails = await fetchArtistsDetails(artistIdSet);
    genreDict = buildGenreDict(tracks,artistDetails);
    localStorage.setItem('genreDictData',JSON.stringify({date:today, dict:genreDict, topArtistIds:Array.from(topArtistIds)}));
    console.log('Tracks:',tracks);
    console.log('Artist Details:',artistDetails);
    console.log('Genre Dictionary:',genreDict);
  }
  let recommendations = await generateRecommendations(genreDict,topArtistIds);
  renderRecommendations(recommendations);
}
main();
})();
</script>
</body>
</html>
