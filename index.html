<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recomendador de Artistas</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background-color: #121212; color: #ffffff; font-family: Arial, sans-serif; padding: 20px; }
  .container { max-width: 600px; margin: 0 auto; }
  .login-container, .progress-container, .resultado { margin-top: 30px; }
  .login-button, .recomendar-button { width: 100%; padding: 15px; border: none; background-color: #1DB954; color: #ffffff; font-size: 16px; border-radius: 25px; cursor: pointer; }
  .login-button:hover, .recomendar-button:hover { opacity: 0.9; }
  .progress-container { text-align: center; font-size: 14px; }
  .resultado h1 { text-align: center; margin-bottom: 20px; }
  .secao { margin-bottom: 30px; }
  .secao h2 { margin-bottom: 10px; font-size: 18px; }
  .lista { display: flex; flex-direction: column; gap: 10px; }
  .card { display: flex; align-items: center; background-color: #181818; border: 1px solid #282828; border-radius: 10px; padding: 10px; text-decoration: none; color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
  .card img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 10px; }
  .card-content { flex: 1; }
  .card-content h3 { font-size: 16px; margin-bottom: 5px; }
  .generos-artista { display: flex; flex-wrap: wrap; gap: 5px; }
  .tag-genero { background-color: #282828; padding: 3px 7px; border-radius: 5px; font-size: 12px; }
  .seta { font-size: 20px; margin-left: auto; }
  @media (min-width: 600px) {
    body { padding: 40px; }
    .card img { width: 80px; height: 80px; }
    .card-content h3 { font-size: 18px; }
  }
</style>
</head>
<body>
<div class="container">
  <div id="loginContainer" class="login-container">
    <button id="loginButton" class="login-button">Entrar com o Spotify</button>
  </div>
  <div id="progressContainer" class="progress-container" style="display:none;"></div>
  <div id="resultado" class="resultado" style="display:none;"></div>
</div>
<script>
(function(){
  let clientId = 'cdbe0b644b984a6e98839e352d87bb3d';
  let redirectUri = 'https://gandradeiasi.github.io/recomendador-de-artista-2/';
  let scopes = 'user-top-read';
  let accessToken = null;
  let genreDict = null;
  let userArtistIds = new Set();
  let recommendedArtistIds = new Set();
  function parseHash(){ let hash = window.location.hash.substring(1); let params = {}; hash.split('&').forEach(part=>{ let [key,value] = part.split('='); params[key]=value; }); return params; }
  function login(){ let authUrl = 'https://accounts.spotify.com/authorize' + '?client_id=' + clientId + '&redirect_uri=' + encodeURIComponent(redirectUri) + '&response_type=token' + '&scope=' + encodeURIComponent(scopes) + '&show_dialog=true'; window.location = authUrl; }
  function updateProgress(text){ let el = document.getElementById('progressContainer'); el.style.display = 'block'; el.innerText = text; }
  function hideProgress(){ let el = document.getElementById('progressContainer'); el.style.display = 'none'; }
  function showResultado(){ document.getElementById('resultado').style.display = 'block'; }
  function hideLogin(){ document.getElementById('loginContainer').style.display = 'none'; }
  async function fetchTopTracks(){ let tracks = []; let offset = 0; let limit = 50; while(true){ updateProgress('Buscando top tracks: ' + tracks.length + ' faixas obtidas'); let url = 'https://api.spotify.com/v1/me/top/tracks?limit=' + limit + '&offset=' + offset; let res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + accessToken } }); let data = await res.json(); if(data.items){ tracks = tracks.concat(data.items); } if(!data.next || tracks.length >= 1000){ break; } offset += limit; } return tracks; }
  async function fetchArtistsDetails(artistIds){ let ids = Array.from(artistIds); let artistMap = {}; for(let i=0;i<ids.length;i+=50){ updateProgress('Buscando detalhes de artistas: ' + (i+1) + ' a ' + Math.min(i+50, ids.length)); let batch = ids.slice(i, i+50).join(','); let url = 'https://api.spotify.com/v1/artists?ids=' + batch; let res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + accessToken } }); let data = await res.json(); if(data.artists){ data.artists.forEach(artist=>{ artistMap[artist.id] = artist; }); } } return artistMap; }
  function computeGenreDict(tracks, artistMap){ let dict = {}; tracks.forEach(track=>{ let trackGenres = new Set(); track.artists.forEach(art=>{ let details = artistMap[art.id]; if(details && details.genres){ details.genres.forEach(g=>{ trackGenres.add(g); }); } }); trackGenres.forEach(g=>{ if(dict[g]){ dict[g]++; } else { dict[g]=1; } }); }); return dict; }
  function storeGenreData(dict){ let today = new Date().toISOString().slice(0,10); localStorage.setItem('genreData', JSON.stringify({date: today, data: dict})); }
  function loadGenreData(){ let stored = localStorage.getItem('genreData'); if(stored){ let obj = JSON.parse(stored); let today = new Date().toISOString().slice(0,10); if(obj.date === today){ return obj.data; } } return null; }
  function splitCounts(dict){ let counts = Object.values(dict); let unique = Array.from(new Set(counts)).sort((a,b)=>a-b); let n = unique.length; let base = Math.floor(n/3); let rem = n % 3; let menos = unique.slice(0, base); let medio = unique.slice(base, base + base + rem); let mais = unique.slice(base + base + rem); return {menos, medio, mais}; }
  function pickGenreForCount(dict, count){ let gs = Object.keys(dict).filter(g=>dict[g]===count); return gs[Math.floor(Math.random()*gs.length)]; }
  async function searchArtistForGenre(genre){ let offset = 0; let valid = []; while(true){ let useQuotes = Math.random() < 0.5; let query = useQuotes ? 'genre:"' + genre + '"' : 'genre:' + genre; updateProgress('Buscando artista para gênero "' + genre + '" (offset ' + offset + ')'); let url = 'https://api.spotify.com/v1/search?q=' + encodeURIComponent(query) + '&type=artist&limit=50&offset=' + offset; let res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + accessToken } }); let data = await res.json(); if(data.artists && data.artists.items.length){ let items = data.artists.items.filter(art=>!userArtistIds.has(art.id) && !recommendedArtistIds.has(art.id)); valid = valid.concat(items); if(valid.length >= 3){ break; } if(!data.artists.next){ break; } offset += 50; } else { break; } }
  if(valid.length===0){ return null; } let chosen = valid[Math.floor(Math.random()*valid.length)]; recommendedArtistIds.add(chosen.id); return chosen;
  }
  async function generateRecommendations(dict){ let groups = splitCounts(dict);
    let rec = {mais:[], medio:[], menos:[]};
    for(let cnt of groups.mais){ let gen = pickGenreForCount(dict, cnt); let art = await searchArtistForGenre(gen); if(art){ rec.mais.push({genero: gen, artista: art}); } }
    for(let cnt of groups.medio){ let gen = pickGenreForCount(dict, cnt); let art = await searchArtistForGenre(gen); if(art){ rec.medio.push({genero: gen, artista: art}); } }
    for(let cnt of groups.menos){ let gen = pickGenreForCount(dict, cnt); let art = await searchArtistForGenre(gen); if(art){ rec.menos.push({genero: gen, artista: art}); } }
    return rec;
  }
  function createCard(art){ let imgUrl = (art.images && art.images.length>0)? art.images[0].url : 'https://via.placeholder.com/80'; let generos = art.genres.join(' ');
    return '<a class="card" href="'+art.external_urls.spotify+'" target="_blank"><img src="'+imgUrl+'"><div class="card-content"><h3>'+art.name+'</h3><div class="generos-artista">'+art.genres.map(g=>'<div class="tag-genero">'+g+'</div>').join('')+'</div></div><div class="seta">&#8250;</div></a>';
  }
  function displayRecommendations(rec){ let container = document.getElementById('resultado'); let html = '<h1>Artistas recomendados:</h1>';
    html += '<div class="secao"><h2>Gêneros que você mais ouve</h2><div class="lista">';
    rec.mais.forEach(item=>{ html += createCard(item.artista); });
    html += '</div></div>';
    html += '<div class="secao"><h2>Gêneros que você ouve mais ou menos</h2><div class="lista">';
    rec.medio.forEach(item=>{ html += createCard(item.artista); });
    html += '</div></div>';
    html += '<div class="secao"><h2>Gêneros que você menos ouve</h2><div class="lista">';
    rec.menos.forEach(item=>{ html += createCard(item.artista); });
    html += '</div></div>';
    html += '<button id="recomendarButton" class="recomendar-button">Gerar novas recomendações</button>';
    container.innerHTML = html;
    container.style.display = 'block';
    document.getElementById('recomendarButton').addEventListener('click', async ()=>{ recommendedArtistIds = new Set(); container.style.display = 'none'; updateProgress('Gerando novas recomendações...'); let novo = await generateRecommendations(genreDict); hideProgress(); displayRecommendations(novo); console.log('Novas recomendações:', novo); });
  }
  async function run(){ recommendedArtistIds = new Set(); updateProgress('Obtendo top tracks...'); let tracks = await fetchTopTracks(); updateProgress('Obtendo detalhes dos artistas...'); tracks.forEach(t=>{ t.artists.forEach(a=>{ userArtistIds.add(a.id); }); });
    let artistMap = await fetchArtistsDetails(userArtistIds);
    updateProgress('Computando dados de gêneros...'); genreDict = computeGenreDict(tracks, artistMap);
    console.log('Genre Dictionary:', genreDict);
    storeGenreData(genreDict);
    updateProgress('Gerando recomendações...'); let rec = await generateRecommendations(genreDict);
    console.log('Recomendações:', rec);
    hideProgress();
    displayRecommendations(rec);
  }
  async function init(){ let params = parseHash(); if(params.access_token){ accessToken = params.access_token; window.location.hash = ''; hideLogin(); } else { let storedToken = sessionStorage.getItem('access_token'); if(storedToken){ accessToken = storedToken; hideLogin(); } }
    if(!accessToken){ return; }
    sessionStorage.setItem('access_token', accessToken);
    let storedGenre = loadGenreData();
    if(storedGenre){ genreDict = storedGenre; updateProgress('Usando dados salvos de gêneros...'); hideProgress(); let rec = await generateRecommendations(genreDict); hideProgress(); displayRecommendations(rec); console.log('Genre Dictionary (localStorage):', genreDict); }
    else { await run(); }
  }
  document.getElementById('loginButton').addEventListener('click', login);
  init();
})();
</script>
</body>
</html>
